<!DOCTYPE html>
<head>
  <meta charset="UTF-8" />
  <title>絕世好武功 經脈計算工具</title>
  <style>
    body {
      margin: 1rem;
    }

    .content {
      display: flex;
      flex-wrap: nowrap;
      align-items: flex-start;
      justify-content: space-between;
    }

    #all-skills {
      max-height: min-content;
      overflow: auto;
    }

    #all-skills h3:first-child {
      margin-top: 0;
    }

    .cart {
      width: 50vw;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
      overflow: auto;
    }
  </style>
</head>
<body>
  <h1>絕世好武功 經脈計算工具</h1>
  <div class="content">
    <div id="all-skills">
      <h3 class="class">純陽</h3>

      <label>灼心訣 <i>方方角</i></label>
      <br />

      <label>玄火劫心功 <i>角圓圓方方角</i></label>
      <br />

      <label>洗髓功 <i>方角圓方方</i> </label>
      <br />

      <label>武當純陽功 <i>方角圓方角圓</i> </label>
      <br />

      <label>紫薇七星訣 <i>圓圓圓角方圓</i></label>
      <br />

      <label>地藏伏魔勁 <i>方方方圓圓圓</i></label>
      <br />

      <label>華嚴地藏經 <i>圓圓圓角圓方</i></label>
      <br />

      <label>爐火鍛體術 <i>方方角角方角</i></label>
      <br />

      <label>霸王舉鼎神功 <i>角角方方角方</i></label>
      <br />

      <h3 class="class">玄陰</h3>

      <label>寒冰訣 <i>圓方角</i></label>
      <br />

      <label>清心訣 <i>角方方圓方角</i></label>
      <br />

      <label>五覺功 <i>圓方角圓圓角</i></label>
      <br />

      <label>玲瓏訣 <i>圓圓角</i></label>
      <br />

      <label>轉星換斗神功 <i>圓圓角圓方圓</i></label>
      <br />

      <label>竟日不全功 <i>角圓方圓角</i></label>
      <br />

      <label>永夜殺法 <i>角角方圓圓</i></label>
      <br />

      <h3 class="class">混元</h3>

      <label>吐納法 <i>圓角方</i></label>
      <br />

      <label>醉仙訣 <i>圓方角圓角角</i></label>
      <br />

      <label>易筋經 <i>圓角方圓角方</i></label>
      <br />

      <label>醉意功 <i>圓角角</i></label>
      <br />

      <label>混元一氣功 <i>角方圓角方</i></label>
      <br />

      <label>羅漢伏魔功 <i>角角方方圓圓</i></label>
      <br />

      <label>金剛護體神功 <i>角角角方方方圓圓圓</i></label>
      <br />

      <label>易筋經「梵」 <i>圓方方角方方圓圓圓</i></label>
      <br />

      <label>蓮花落 <i>圓圓角方</i></label>
      <br />

      <label>混元先天功 <i>無</i></label>
      <br />

      <h3 class="class">毒煞</h3>

      <label>避毒訣 <i>方方角圓角</i></label>
      <br />

      <label>奪魄功 <i>方方圓角角</i></label>
      <br />

      <label>解蠱訣 <i>圓角方角圓</i></label>
      <br />

      <h3 class="class">綜合內功</h3>

      <label>化龍功 <i>圓方角方圓方</i></label>
      <br />

      <label>血煞吐納功 <i>角角方圓角</i></label>
      <br />

      <label>金針度穴功 <i>方圓方角圓角</i></label>
      <br />

      <label>偷天換日功 <i>圓角角方方</i></label>
      <br />

      <label>馭獸訣 <i>方圓方</i></label>
      <br />

      <label>形意五禽功 <i>角方圓方角</i></label>
      <br />

      <label>玄龜養生術 <i>方方角角</i></label>
      <br />

      <label>搬血鍛體訣 <i>角方角方角</i></label>
      <br />

      <label>擒龍伏虎功 <i>角方圓圓</i></label>
      <br />

      <label>武當太和功 <i>方圓角圓角圓方</i></label>
      <br />

      <label>無跡心訣 <i>方角圓圓角方</i></label>
      <br />

      <label>紫霞劍氣 <i>角圓方方圓角</i></label>
      <br />

      <label>真法 <i>圓角方圓方角方角圓方圓角角方圓角圓方</i></label>
      <br />

      <label>奉劍訣 <i>無</i></label>
      <br />

      <label>人蠱蟲巢法 <i>角角角角方</i></label>
      <br />
    </div>

    <div class="cart">
      <div>
        <label for="input">按照喜好順序貼上內功+空格+穴位</label>
        <br />
        <label for="input"><i>(新功法或逆練請自行修改穴位)</i></label>
      </div>
      <textarea id="input" name="skills" rows="15" cols="50">
真法 圓角方圓方角方角圓方圓角角方圓角圓方
易筋經「梵」 圓方方角方方圓圓圓
無跡心訣 方角圓圓角方
紫霞劍氣 角圓方方圓角
武當太和功 方圓角圓角圓方
</textarea
      >
      <div>
        <label for="count">穴位數 (20 30 45):</label>
        <input type="number" id="maxSize" value="45" />
      </div>
      <button type="button" onclick="calculate()">計算</button>

      <div id="result-display" style="display: none">
        <label for="output">穴位順序:</label>
        <pre id="output"></pre>

        <label for="skills">激活功法:</label>
        <pre id="skills"></pre>
      </div>
    </div>
  </div>
  <script>
    const allSkills = [
      //純陽
      { name: "灼心訣", value: "方方角" },
      { name: "玄火劫心功", value: "角圓圓方方角" },
      { name: "洗髓功", value: "方角圓方方" },
      { name: "武當純陽功", value: "方角圓方角圓" },
      { name: "紫薇七星訣", value: "圓圓圓角方圓" },
      { name: "地藏伏魔勁", value: "方方方圓圓圓" },
      { name: "華嚴地藏經", value: "圓圓圓角圓方" },
      { name: "爐火鍛體術", value: "方方角角方角" },
      { name: "霸王舉鼎神功", value: "角角方方角方" },
      //玄陰
      { name: "寒冰訣", value: "圓方角" },
      { name: "清心訣", value: "角方方圓方角" },
      { name: "五覺功", value: "圓方角圓圓角" },
      { name: "玲瓏訣", value: "圓圓角" },
      { name: "轉星換斗神功", value: "圓圓角圓方圓" },
      { name: "竟日不全功", value: "角圓方圓角" },
      { name: "永夜殺法", value: "角角方圓圓" },
      //混元
      { name: "吐納法", value: "圓角方" },
      { name: "醉仙訣", value: "圓方角圓角角" },
      { name: "易筋經", value: "圓角方圓角方" },
      { name: "醉意功", value: "圓角角" },
      { name: "混元一氣功", value: "角方圓角方" },
      { name: "羅漢伏魔功", value: "角角方方圓圓" },
      { name: "金剛護體神功", value: "角角角方方方圓圓圓" },
      { name: "易筋經「梵」", value: "圓方方角方方圓圓圓" },
      { name: "蓮花落", value: "圓圓角方" },
      { name: "混元先天功", value: "無" },
      //毒煞
      { name: "避毒訣", value: "方方角圓角" },
      { name: "奪魄功", value: "方方圓角角" },
      { name: "解蠱訣", value: "圓角方角圓" },
      //綜合內功
      { name: "化龍功", value: "圓方角方圓方" },
      { name: "血煞吐納功", value: "角角方圓角" },
      { name: "金針度穴功", value: "方圓方角圓角" },
      { name: "偷天換日功", value: "圓角角方方" },
      { name: "馭獸訣", value: "方圓方" },
      { name: "形意五禽功", value: "角方圓方角" },
      { name: "玄龜養生術", value: "方方角角" },
      { name: "搬血鍛體訣", value: "角方角方角" },
      { name: "擒龍伏虎功", value: "角方圓圓" },
      { name: "武當太和功", value: "方圓角圓角圓方" },
      { name: "無跡心訣", value: "方角圓圓角方" },
      { name: "紫霞劍氣", value: "角圓方方圓角" },
      { name: "真法", value: "圓角方圓方 角方角圓方圓角 角方圓角圓方" },
      { name: "奉劍訣", value: "無" },
      { name: "人蠱蟲巢法", value: "角角角角方" },
    ];

    function calculate() {
      let input = document.getElementById("input").value;
      let maxSize = document.getElementById("maxSize").value;

      let list = [];
      input.split("\n").forEach((item) => {
        if (!/^.*?\s.*?/.test(item)) {
          return;
        }
        list.push({
          name: item.split(" ")[0],
          value: item.split(" ")[1],
        });
      });

      let result = findBestWithinMax(list, maxSize);

      console.log(result);

      document.getElementById("result-display").style.display = "block";

      document.getElementById("output").innerHTML = result.shortest + `(共計${result.length}穴位)`;

      let enabledSkills = [];
      list.forEach((item) => {
        if (result.supported.includes(item.value)) {
          enabledSkills.push(item.name);
        }
      });

      console.log(enabledSkills);

      document.getElementById("skills").innerHTML = enabledSkills.join("\n");
    }

    function findBestWithinMax(list, max) {
      let latest = "";
      let supported = [];

      for (let i = 0; i < list.length; i++) {
        let shortest = shortestSuperstring([...supported, list[i].value]);
        if (shortest.length <= max) {
          latest = shortest;
          supported.push(list[i].value);
        }
      }

      return {
        shortest: latest,
        length: latest.length,
        supported,
      };
    }

    function shortestSuperstring(words) {
      let n = words.length;

      let overlap = Array.from({ length: n }, () => Array(n).fill(0));
      for (let i = 0; i < n; i++) {
        for (let j = 0; j < n; j++) {
          if (i !== j) {
            overlap[i][j] = getOverlap(words[i], words[j]);
          }
        }
      }

      let dp = Array.from({ length: 1 << n }, () => Array(n).fill(Infinity));
      let parent = Array.from({ length: 1 << n }, () => Array(n).fill(-1));

      for (let i = 0; i < n; i++) {
        dp[1 << i][i] = words[i].length;
      }

      for (let mask = 1; mask < 1 << n; mask++) {
        for (let i = 0; i < n; i++) {
          if ((mask & (1 << i)) === 0) continue;
          let prevMask = mask ^ (1 << i);
          for (let j = 0; j < n; j++) {
            if ((prevMask & (1 << j)) === 0) continue;
            let newLength = dp[prevMask][j] + overlap[j][i];
            if (newLength < dp[mask][i]) {
              dp[mask][i] = newLength;
              parent[mask][i] = j;
            }
          }
        }
      }

      let lastWord = -1;
      let minLength = Infinity;
      let finalMask = (1 << n) - 1;

      for (let i = 0; i < n; i++) {
        if (dp[finalMask][i] < minLength) {
          minLength = dp[finalMask][i];
          lastWord = i;
        }
      }

      let mask = finalMask;
      let sequence = [];

      while (mask > 0) {
        sequence.push(lastWord);
        let prev = lastWord;
        lastWord = parent[mask][lastWord];
        mask ^= 1 << prev;
      }

      sequence.reverse();

      let result = words[sequence[0]];
      for (let i = 1; i < sequence.length; i++) {
        let overlapLen = overlap[sequence[i - 1]][sequence[i]];
        result += words[sequence[i]].substring(words[sequence[i]].length - overlapLen);
      }

      return result;
    }

    function getOverlap(a, b) {
      for (let len = Math.min(a.length, b.length); len > 0; len--) {
        if (a.endsWith(b.substring(0, len))) {
          return b.length - len;
        }
      }
      return b.length;
    }
  </script>
</body>
